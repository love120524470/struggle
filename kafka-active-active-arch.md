## kafka同城双活方案思考

kafka集群同城双活方案思考
思路
1，先简单引出kafka双活集群搭建的问题
2，面临的困难，zookeeper无法做高可用
3，解决，zookeeper双机房部署，一个奇数，一个偶数，但是存在风险（zookeeper集群的特性，半数以上存活可用）
4，但还是存在风险，如果多zookeeper的那个机房挂掉，还是存在zookeeper集群不可用的情况，无法选举，比如创建一个topic，无法在zk上写入成功
5，同城三机房，将zookeeper在三个机房搭建一个集群，两个机房偶数，一个机房奇数
kafka集群两个机房部署，对等部署，创建副本时保证副本会跨机房，支持机架配置
同城光纤毫米级延迟

https://istock.ssetech.com.cn/wiki/doku.php?id=service:techmag:201712_029:09


### kafka双活集群方案

一般情况下，我们的一个kafka集群都是部署在同一个机房的，如这样（图）：

这是一个很普通的kafka集群部署架构图，可以满足我们一般场景下的消息传输。但是金融场景下，要求消息中间件达到很高的可用性，这个部署架构不满足我们金融级别的可用性。

#### 方案1
问题在哪里呢？
如果这个集群所在的机房整体挂掉了怎么办？这种情况不是没有发生过，比如机房网线被挖断了怎么办？（图片），比如前段时间的aws的光纤被挖断，造成很大的损失？

遇到这种很少的情况怎么办呢？我们调整了下部署架构（图）：

这个架构跟前面最大的区别是增加kafka集群被分布到两个机房了，他们构成了一个统一的集群。一般情况下这样的机房是同城两个机房，比如公有云华东机器的ECA和ECB，他们就是在上海同城的两个机房，两个机房间由光纤专线，同城机房间访问能做到ms级延迟。
改造成这个架构后，kafka集群节点分别分布到两个不同的机房，一个机房故障后，可以把外部业务访问流量导入到另外一个机房，kafka客户端自动failover，kafka服务不受影响。这个架构保证了kafka服务的高可用。
#### 方案1优化
不过，这时还无法保证数据的高可用，基于kafka副本复制的原理，我们只需要分区的副本不要集中在同一个机房就可以了，这个时候我们有两种方式来实现：
1，创建topic时指定分区数大于单一机房的集群节点数，比如kafka集群1在ECA机房有2个节点，在ecb有2个节点，创建topic的时候指定分区副本数n>2，由于同一分区副本会分布在不同broker节点上，所以必定在ecb和ecb的节点都有该分区的副本。
2，kafka机架感知功能，配置broker.rack=rack-id-n，当创建，更新或者replicas重新分布时，将会遵从分组规则，确保单个partition的所有replicas被分散到尽可能多的组内，最多会被分散到min(#racks, replication-factor) 个不同的组。
从上面的两种方案来看，第一种方式很直观，但是副本数越多，副本同步成本越高，n个副本复制流量为消息生产流量的n-1倍，按照ecb和eca分别有2个broker节点的话，那么副本数至少为3。第二种方式很简单，也很轻量，我们可以将eca的两个broker节点分为1组，ecb的两个broker节点分为另外1组，创建副本时，会保证副本分布到不同的分组中，这样副本数最少可以是2，可以在保证数据高可用的同时，减少了副本复制，提高了性能

在这个时候，可能有人说了kafka集群已经跨机房了，可以保证高可用了。
是的，kafka 集群确实可以保证很高的高可用了，哪怕是eca机房挂了，ecb的kafka节点依然可以提供正常的服务。

#### 方案2
是的，可是大家有没有注意到kafka集群依赖zookeeper集群实现元数据管理，比如topic元数据，分区元数据，broker节点元数据等。没有zookeeper集群，就无法构建起来kafka集群。前面架构中zookeeper集群中节点是在一个机房ECA机房，这里会存在单点问题，eca机房挂了之后，zk集群也挂了，ecb集群中只有kafka broker节点，kafka集群无法对外提供kafka服务。
那么，我们怎么解决zookeeper集群的高可用问题呢？
同样，我们可以把zk集群分布在eca和ecb两个机房，如架构图：

这样，eca机房有3个zk节点，ecb机房有2个zk节点，共同组成一个zk集群。机房ecb挂了之后，eca的3个zk节点依然可以为eca的两个kafka broker提供zk服务，kafka集群依然可以对外提供无损的服务。

#### 方案3
看到这里，有人会以为咱们的kafka 同城双活方案已经完善了，其实，在这里还有个比较大的问题：如果eca机房挂了怎么办？
我们来分析下，eca机房挂了，3个zk节点挂了，2个broker节点挂了，还剩ecb的2个zk节点，2个broker节点，有人会说kafka集群还可以提供服务呀，大家有没有注意到我们zk集群的节点是奇数，zookeeper集群由于使用的zab算法实现的一致性协议（类似paxos算法），paxos算法要求，zk节点必须要是奇数，否则可能无法完成选举。该算法还有个特点是，在zk集群节点故障的情况，只要半数存活，paxos算法依然可以保证zk集群继续提供可用服务。
那么，在前面提到的这个场景下，eca机房挂了，ecb机房的2个zk节点未过半数，剩下的zk集群无法提供服务。

#### 方案4
既然必须是奇数，我们的机房又这样，那是不是必定zk集群多活就走不通了？
其实不然，我们前面说的kafka双活，我们没有说zk也必须要双活呀，我们可以让zk集群三活，或者n活，架构图如下：
这里，我们在eca和ecb之外另外一个机房ecc部署了zk节点加入到zk集群中，eca和ecb机房中zk节点数相同，zk集群节点数=2n+m,n是eca和ecb机房的zk节点数，m是ecc机房的zk节点数，其中，m<2n，2n+m是奇数（例如m=1,n=1,zk集群节点为3），也就是说一旦ecc机房挂了之后，剩下eca和ecb机房的zk存活节点依然可以保证半数以上。所以这个方案中，eca，ecb，ecc任意一个机房挂掉之后，剩下的zk集群依然可用，且剩下的kafka集群依然可以提供服务。

到这里，kafka同城双活方案很完善了，有人可能又要问了，如果两个机房都挂掉了怎么办？其实挂掉一个机房的概率已经很小了，同时挂掉连个机房的概率就更小了。
有人可能还会问如果这个城市的所有机房都挂了怎么办？比如地震什么的。那么这个就是灾备环境需要考虑的方案了














